<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>รายการ</title>
  <link rel="stylesheet" href="css/menu1.1.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>

  <div class="header">
    <h2>User ยืม </h2>
    <h3>ver0.1</h3>
    <button class="back-btn" onclick="history.back()">
      <i class="fa fa-chevron-left"></i> ย้อนกลับ
    </button>
  </div>

  <div class="table-container">
    <table id="dataTable">
      <thead>
        <tr>
          <th>Filter</th>
          <th>ID Number</th>
          <th>ชื่อ</th>
          <th>แผนก</th>
          <th>Create Date</th>
          <th>Status</th>
          <th>
            <div class="action-header">
              <span>Actions</span>
              <button class="add-btn" id="addBtn">+ เพิ่มรายการ</button>
            </div>
          </th>

        </tr>
      </thead>
      <tbody id="tableBody">
        <!-- แถวข้อมูลจะถูกสร้างด้วย JS -->
      </tbody>
    </table>
  </div>


<div id="addModal" class="modal">
    <div class="modal-content">
        <span class="close-btn">&times;</span>
        <h2>เพิ่มรายการใหม่</h2>
        <form id="addDataForm">
            <div class="form-group">
                <label for="idNumber">ID Number:</label>
                <input type="text" id="idNumber" name="idNumber" required>
            </div>
            <div class="form-group">
                <label for="name">ชื่อ:</label>
                <input type="text" id="name" name="name" required>
            </div>
            <div class="form-group">
                <label for="department">แผนก:</label>
                <select id="department" name="department" required>
                    <option value="tr">tr</option>
                    <option value="tvb">tvb</option>
                    <option value="tv3">tv3</option>
                    <option value="vg">vg</option>
                </select>
            </div>
            <div class="form-group">
                <label for="createDate">Create Date:</label>
                <input type="date" id="createDate" name="createDate" required>
            </div>
            <div class="form-group">
                <label for="status">สถานะ:</label>
                <select id="status" name="status" required>
                    <option value="ยืม">ยืม</option>
                    <option value="คืน">คืน</option>
                </select>
            </div>
            <button type="submit" id="saveBtn">บันทึก</button>
        </form>
    </div>
</div>

<script>
    const tableBody = document.getElementById("tableBody");
    const addBtn = document.getElementById("addBtn");
    const modal = document.getElementById("addModal");
    const closeBtn = document.querySelector(".close-btn");
    const addDataForm = document.getElementById("addDataForm");

    // URL สำหรับดึงข้อมูลจาก Google Sheet
    const sheetUrl = "https://script.google.com/macros/s/AKfycbw0ZxtNjBd6Y9Eyc7PnzZKAf3TYKnPtCbjbjjKBtYShnBeK6SisLex3zmmkVxjCWIwdlg/exec";

    // URL สำหรับส่งข้อมูลไปยัง Google Sheet (ต้องสร้างใหม่)
    const addDataUrl = "https://script.google.com/macros/s/AKfycbxUxKAm1h_TP58wMV5hOkY9n_GVfbvwyGX7iBDQYhs8Fnuhzc4HeGAzRIRHYEfMogJd_Q/exec";

    // ฟังก์ชันสำหรับดึงข้อมูลและแสดงผลในตาราง (เหมือนเดิม)
    async function fetchDataAndRenderTable() {
        // ... (โค้ด fetchDataAndRenderTable เดิม) ...
        try {
            const response = await fetch(sheetUrl);
            const data = await response.json();

            tableBody.innerHTML = ''; // ล้างข้อมูลเดิมในตาราง

            data.forEach(rowData => {
                const tr = document.createElement("tr");
                tr.classList.add("expandable");

                tr.innerHTML = `
                    <td>-</td>
                    <td>${rowData['ID Number']}</td>
                    <td>${rowData['ชื่อ']}</td>
                    <td>${rowData['แผนก']}</td>
                    <td>${rowData['Create Date']}</td>
                    <td>${rowData['Status']}</td>
                    <td>
                        <button class="action-btn edit">แก้ไข</button>
                        <button class="action-btn delete">ลบ</button>
                    </td>
                `;

                const detailsRow = document.createElement("tr");
                detailsRow.className = "details-row";
                detailsRow.innerHTML = `
                    <td colspan="7" class="details-cell">
                        <b>รายละเอียดของรายการ</b><br>
                        ข้อมูลเพิ่มเติม: ${rowData['เพิ่มเติม'] || ''}
                    </td>
                `;

                tr.addEventListener("click", () => {
                    detailsRow.style.display =
                        detailsRow.style.display === "table-row" ? "none" : "table-row";
                });

                tableBody.appendChild(tr);
                tableBody.appendChild(detailsRow);
            });

        } catch (error) {
            console.error("Error fetching data:", error);
            tableBody.innerHTML = `<tr><td colspan="7">เกิดข้อผิดพลาดในการโหลดข้อมูล</td></tr>`;
        }
    }
    
    // ฟังก์ชันสำหรับส่งข้อมูลจากฟอร์มไปยัง Google Sheet
    async function submitData(event) {
        event.preventDefault();

        const formData = new FormData(addDataForm);
        const data = {
            'ID Number': formData.get('idNumber'),
            'แผนก': formData.get('department'),
            'Create Date': formData.get('createDate'),
            'Status': formData.get('status')
        };

        try {
            const response = await fetch(addDataUrl, {
                method: 'POST',
                body: JSON.stringify(data),
                headers: {
                    'Content-Type': 'text/plain;charset=utf-8'
                }
            });

            const result = await response.json();
            if (result.status === 'success') {
                alert('บันทึกข้อมูลเรียบร้อยแล้ว!');
                modal.style.display = "none";
                fetchDataAndRenderTable(); // โหลดข้อมูลใหม่หลังจากบันทึก
            } else {
                alert('เกิดข้อผิดพลาดในการบันทึกข้อมูล: ' + result.message);
            }
        } catch (error) {
            console.error('Error submitting data:', error);
            alert('ไม่สามารถเชื่อมต่อเพื่อบันทึกข้อมูลได้');
        }
    }

    // Event listeners
    addBtn.addEventListener("click", () => {
        modal.style.display = "block";
    });

    closeBtn.addEventListener("click", () => {
        modal.style.display = "none";
    });

    window.addEventListener("click", (event) => {
        if (event.target == modal) {
            modal.style.display = "none";
        }
    });

    addDataForm.addEventListener("submit", submitData);

    // เรียกฟังก์ชันเมื่อหน้าเว็บโหลดเสร็จ
    document.addEventListener("DOMContentLoaded", fetchDataAndRenderTable);

</script>

</body>

</html>